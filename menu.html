<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TORB - Men√π Asporto</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://gateway.sumup.com/gateway/ecom/card/v2/sdk.js"></script>
    
    <style>
        :root {
            --bg-body: #f7f9fa;       
            --bg-card: #ffffff;       
            --bg-header: #ffffff;     
            --accent-gold: #b8860b;   
            --accent-fire: #d32f2f;   
            --text-main: #1a1a1a;     
            --text-muted: #666666;    
            --border-light: #e0e0e0;  
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Montserrat', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg-body); color: var(--text-main); padding-bottom: 120px; min-height: 100vh; }

        /* PROMO BAR */
        .promo-bar {
            background: var(--accent-fire);
            color: #fff;
            text-align: center;
            padding: 10px 15px;
            font-weight: 800;
            font-size: 0.85rem;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        /* PROMO ALERTS NEL CARRELLO */
        .promo-alert {
            background: rgba(184, 134, 11, 0.1);
            border: 1px dashed var(--accent-gold);
            color: var(--accent-gold);
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            font-size: 0.95rem;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        .promo-alert.success {
            background: rgba(211, 47, 47, 0.05);
            border-color: var(--accent-fire);
            color: var(--accent-fire);
        }

        /* HEADER */
        header { text-align: center; padding: 30px 20px 40px; background: var(--bg-header); border-bottom: 1px solid var(--border-light); }
        .header-logo { max-width: 220px; margin: 0 auto 20px; display: block; }
        .hero-subtitle-action { color: var(--accent-gold); font-size: 1.3rem; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; }

        /* FILTRI & MENU */
        .filters-container { display: flex; overflow-x: auto; gap: 10px; padding: 15px 20px; position: sticky; top: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); z-index: 100; border-bottom: 1px solid var(--border-light); box-shadow: 0 4px 10px rgba(0,0,0,0.03);}
        .filters-container::-webkit-scrollbar { display: none; }
        .filter-btn { background: var(--bg-body); color: var(--text-main); border: 1px solid var(--border-light); padding: 8px 18px; border-radius: 4px; font-weight: 600; font-size: 0.85rem; white-space: nowrap; cursor: pointer; text-transform: uppercase; transition: all 0.3s; }
        .filter-btn.active { background: var(--accent-gold); color: #ffffff; border-color: var(--accent-gold); box-shadow: 0 4px 10px rgba(184, 134, 11, 0.2); }
        
        .menu-container { padding: 0 15px; max-width: 1000px; margin: 0 auto;}
        .category-section { display: block; animation: fadeIn 0.4s ease-in-out; }
        .category-section.hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .category-title { padding: 40px 5px 15px; font-size: 1.6rem; font-weight: 900; color: var(--accent-gold); text-transform: uppercase; border-bottom: 1px dashed var(--border-light); margin-bottom: 15px; }
        
        .menu-item { background: var(--bg-card); border: 1px solid var(--border-light); border-radius: 8px; padding: 20px; margin: 15px 0; display: flex; flex-direction: column; box-shadow: 0 4px 15px rgba(0,0,0,0.04); transition: transform 0.2s;}
        
        .item-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .item-name { font-size: 1.1rem; font-weight: 800; color: var(--text-main); line-height: 1.3; padding-right: 10px; text-transform: uppercase;}
        .item-price { font-size: 1.2rem; font-weight: 800; color: var(--accent-gold); white-space: nowrap; }
        .item-desc { font-size: 0.85rem; color: var(--text-muted); line-height: 1.5; margin-bottom: 15px; flex-grow: 1; font-weight: 500;}
        
        .controls { display: flex; align-items: center; justify-content: space-between; margin-top: auto; padding-top: 15px; border-top: 1px solid var(--border-light); }
        .qty-box { display: flex; align-items: center; gap: 15px; }
        
        .btn-control { background: var(--bg-body); color: var(--text-main); border: 1px solid var(--border-light); border-radius: 4px; width: 32px; height: 32px; font-size: 1rem; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s;}
        .btn-control:hover { border-color: var(--accent-gold); color: var(--accent-gold); }
        .qty { font-weight: 800; font-size: 1.2rem; min-width: 25px; text-align: center; }

        .btn-custom { background: transparent; color: var(--text-muted); border: 1px solid var(--border-light); border-radius: 4px; padding: 6px 12px; font-size: 0.75rem; font-weight: 700; cursor: pointer; text-transform: uppercase; transition: 0.2s;}
        .btn-custom:hover { border-color: var(--accent-fire); color: var(--accent-fire); }
        
        .variant-item { background: var(--bg-body); padding: 12px; border-radius: 4px; margin-top: 12px; border-left: 3px solid var(--accent-fire); border: 1px solid var(--border-light);}
        .variant-desc { font-size: 0.8rem; color: var(--accent-fire); margin-bottom: 5px; line-height: 1.4; font-weight: 600;}
        .variant-header { display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; font-weight: 800; margin-bottom: 5px;}

        /* MODALI */
        .checkout-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 15px; }
        .checkout-modal.active { display: flex; }
        .checkout-content { background: var(--bg-card); border: none; box-shadow: 0 15px 50px rgba(0,0,0,0.2); border-radius: 8px; width: 100%; max-width: 500px; position: relative; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
        
        .modal-header { padding: 20px 25px; background: var(--bg-header); border-bottom: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10;}
        .modal-header h3 { color: var(--accent-gold); margin: 0; font-size: 1.2rem; font-weight: 800; }
        .close-modal { color: var(--text-muted); font-size: 1.5rem; cursor: pointer; transition: 0.2s;}
        .close-modal:hover { color: var(--text-main); }
        .modal-body { padding: 20px 25px; }

        .custom-option-card { display: flex; justify-content: space-between; align-items: center; font-size: 0.95rem; background: var(--bg-body); padding: 15px; border-radius: 4px; border: 1px solid var(--border-light); margin-bottom: 10px; cursor: pointer; font-weight: 500;}
        .custom-option-left input { margin-right: 15px; accent-color: var(--accent-fire); transform: scale(1.3); }

        .recap-list { background: var(--bg-body); border-radius: 8px; padding: 15px; max-height: 250px; overflow-y: auto; border: 1px solid var(--border-light); margin-bottom: 15px;}
        .recap-item { display: flex; justify-content: space-between; align-items: center; font-size: 0.95rem; font-weight: 500; margin-bottom: 12px; border-bottom: 1px solid var(--border-light); padding-bottom: 12px;}
        .recap-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0;}
        .btn-remove-recap { background: transparent; color: var(--text-muted); border: 1px solid var(--border-light); border-radius: 4px; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s;}
        .btn-remove-recap:hover { color: var(--accent-fire); border-color: var(--accent-fire); background: #fff5f5; }

        /* UPSELL */
        .upsell-container { display: grid; grid-template-columns: 1fr; gap: 12px; padding-bottom: 10px; margin-top: 15px; }
        .upsell-card { background: var(--bg-body); border: 1px solid var(--border-light); padding: 15px; border-radius: 8px; text-align: center; display: flex; flex-direction: column; justify-content: center; }
        .upsell-card h4 { font-size: 0.95rem; margin-bottom: 8px; color: var(--text-main); font-weight: 700;}
        .btn-upsell { background: transparent; color: var(--accent-gold); border: 1px solid var(--accent-gold); padding: 10px; border-radius: 4px; font-size: 0.8rem; font-weight: 800; width: 100%; text-transform: uppercase; margin-top: 10px; cursor: pointer; transition: all 0.3s; }
        .btn-upsell:hover { background: var(--accent-gold); color: #ffffff; }

        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; font-size: 0.8rem; font-weight: 700; margin-bottom: 5px; color: var(--text-muted); text-transform: uppercase;}
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 14px; border-radius: 4px; background: var(--bg-body); border: 1px solid var(--border-light); color: var(--text-main); outline: none; font-family: inherit; font-size: 1rem; font-weight: 500;}
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color: var(--accent-gold); box-shadow: 0 0 0 2px rgba(184, 134, 11, 0.1); background: #ffffff; }

        .btn-confirm-order { width: 100%; background: var(--accent-gold); color: #ffffff; border: none; padding: 18px; border-radius: 4px; font-size: 1.1rem; font-weight: 900; text-transform: uppercase; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px; transition: background 0.3s; box-shadow: 0 4px 15px rgba(184, 134, 11, 0.2); }
        .btn-confirm-order:hover { background: #9e730a; box-shadow: 0 6px 20px rgba(184, 134, 11, 0.3); }
        .btn-confirm-order:disabled { opacity: 0.7; cursor: not-allowed; }
        
        .alert-box { background: #fff5f5; border: 1px dashed var(--accent-fire); padding: 15px; border-radius: 4px; margin-bottom: 20px; font-size: 0.85rem; color: var(--accent-fire); line-height: 1.5; font-weight: 500;}

        .cart-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--bg-header); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border-light); transform: translateY(120%); transition: transform 0.3s ease; z-index: 1000; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); }
        .cart-footer.visible { transform: translateY(0); }
        .cart-total { font-size: 1.4rem; font-weight: 900; color: var(--accent-gold); display: flex; align-items: center;}
        .btn-checkout { background: var(--accent-gold); color: #ffffff; border: none; padding: 14px 28px; border-radius: 4px; font-size: 1rem; font-weight: 900; text-transform: uppercase; cursor: pointer; box-shadow: 0 4px 15px rgba(184, 134, 11, 0.2); transition: 0.3s;}
        .btn-checkout:hover { background: #9e730a; }

        @media (min-width: 768px) {
            .filters-container { justify-content: center; }
            .category-section { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
            .category-title { grid-column: span 2; }
            .menu-item { margin: 0; height: 100%; }
            .upsell-container { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>

    <div class="promo-bar">
        üî• SCONTO 10% SUGLI ORDINI SOPRA I 20‚Ç¨ | SCONTO 20% SOPRA I 50‚Ç¨ üî•
    </div>

    <header>
        <img src="images/logouff.svg" alt="TORB" class="header-logo" onerror="this.src='images/logo.png';">
        <h2 class="hero-subtitle-action">Ordina qui e ritira in sede</h2>
    </header>

    <div class="filters-container" id="filters-container"></div>
    <div id="menu-container" class="menu-container"></div>

    <div class="cart-footer" id="cart-footer">
        <div>
            <span style="display:block; font-size: 0.75rem; color: var(--text-muted); font-weight:700; text-transform: uppercase;">Totale Ordine</span>
            <div class="cart-total" id="total-price">0,00 ‚Ç¨</div>
        </div>
        <button class="btn-checkout" onclick="openRecap()">Procedi <i class="fa-solid fa-arrow-right"></i></button>
    </div>

    <div class="checkout-modal" id="custom-modal" onclick="if(event.target === this) closeCustomModal()">
        <div class="checkout-content">
            <div class="modal-header">
                <h3 id="custom-title">Personalizza</h3>
                <i class="fa-solid fa-xmark close-modal" onclick="closeCustomModal()"></i>
            </div>
            <div class="modal-body">
                <p style="font-size: 0.85rem; color: var(--text-muted); font-weight: 500; margin-bottom: 15px;">Seleziona gli ingredienti da rimuovere.</p>
                <div id="custom-dynamic-sections"></div>
            </div>
            <div style="padding: 20px; border-top: 1px solid var(--border-light); background: #fafafa;">
                <button class="btn-confirm-order" onclick="addCustomItemToCart()">Conferma</button>
            </div>
        </div>
    </div>

    <div class="checkout-modal" id="recap-modal" onclick="if(event.target === this) closeRecap()">
        <div class="checkout-content">
            <div class="modal-header">
                <h3>Il tuo Ordine</h3>
                <i class="fa-solid fa-xmark close-modal" onclick="closeRecap()"></i>
            </div>
            <div class="modal-body">
                <div class="recap-list" id="recap-list-container"></div>
                
                <div id="recap-promo-alert"></div>
                
                <h4 style="color: var(--accent-gold); margin-top: 25px; font-size: 1.1rem; font-weight: 900; text-transform: uppercase;">Completa l'ordine</h4>
                <p style="font-size: 0.85rem; color: var(--text-muted); font-weight: 500; margin-bottom: 10px;">Aggiungi al volo i nostri preferiti:</p>
                <div class="upsell-container" id="upsell-container"></div>
            </div>
            <div style="padding: 20px; border-top: 1px solid var(--border-light); background: #fafafa;">
                <button class="btn-confirm-order" onclick="proceedToCheckout()">Vai al Checkout</button>
            </div>
        </div>
    </div>

    <div class="checkout-modal" id="checkout-modal" onclick="if(event.target === this) closeCheckout()">
        <div class="checkout-content">
            <div class="modal-header">
                <h3>Dati Ritiro</h3>
                <i class="fa-solid fa-xmark close-modal" onclick="closeCheckout()"></i>
            </div>
            <div class="modal-body">
                
                <div id="checkout-order-info"></div>

                <div id="sumup-card-container" style="display: none; background: white; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                    <div id="sumup-card"></div>
                </div>

                <div id="dati-cliente-form">
                    <div class="form-group">
                        <label>Nome e Cognome *</label>
                        <input type="text" id="cust-name" required placeholder="Es. Mario Rossi">
                    </div>
                    <div class="form-group">
                        <label>Orario Ritiro (Locale) *</label>
                        <select id="orario-consegna" name="orario" required></select>
                    </div>
                    <div class="form-group">
                        <label>Note Cucina / Cotture</label>
                        <textarea id="cust-notes" rows="2" placeholder="Es. Hamburger ben cotto, salse a parte..."></textarea>
                    </div>
                    
                    <div class="alert-box">
                        <p><strong>‚ö†Ô∏è ORDINI AUTOMATICI:</strong> Il numero WhatsApp riceve solo comande automatizzate, non legge messaggi testuali.</p><br>
                        <p><strong>üö´ NESSUN ANNULLAMENTO:</strong> Dopo il pagamento (SumUp), l'ordine viene inviato in cucina e non √® rimborsabile. Passa a ritirarlo puntuale all'orario scelto.</p>
                    </div>
                    
                    <button class="btn-confirm-order" onclick="sendOrderWithDetails()" id="pay-btn">
                        <i class="fa-solid fa-credit-card"></i> Paga Ora (SumUp)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const menuData = [
            {
                id: "antipasti", category: "Antipasti",
                items: [
                    { id: 101, name: "Patate fritte", desc: "", price: 4.50 },
                    { id: 102, name: "Patate fritte, salsiccia e fonduta", desc: "", price: 6.50 },
                    { id: 103, name: "Patate fritte e w√ºrstel", desc: "", price: 5.50 },
                    { id: 104, name: "Pollo crispy", desc: "", price: 10.00 },
                    { id: 105, name: "Polpette di Pulled Pork", desc: "panate con mandorle", price: 9.50 },
                    { id: 106, name: "Polpette di Black Angus", desc: "con fonduta di parmigiano", price: 10.00 },
                    { id: 107, name: "Ali di pollo Cornflakes", desc: "", price: 9.50 }
                ]
            },
            {
                id: "panini", category: "Panini",
                items: [
                    { id: 201, name: "Chicken", desc: "Pollo panato Cornflakes, provola, insalata, mayo", price: 11.00 },
                    { id: 202, name: "Burger Torb", desc: "Hamburger 180gr, insalata, pomodoro, cheddar, bacon, cipolla croccante, salsa Torb", price: 12.00 },
                    { id: 203, name: "Pulled Pork", desc: "Pulled Pork, chutney di peperoni, mayo al fondo bruno, patate al forno, tarallo", price: 11.00 },
                    { id: 204, name: "La Tradizione", desc: "Hamburger di salsiccia, provola, friarielli, mandorle tostate", price: 10.00 }
                ]
            },
            {
                id: "carne", category: "La Carne",
                items: [
                    { id: 301, name: "Filetto bruno e patate", desc: "Filetto 250gr, fondo bruno e patate in tripla cottura", price: 32.00 },
                    { id: 302, name: "Filetto con contorno", desc: "Filetto 250gr con 1 contorno a scelta", price: 30.00 },
                    { id: 303, name: "Tagliata con contorno", desc: "Tagliata 300gr con 1 contorno a scelta", price: 30.00 },
                    { id: 304, name: "Salsiccia e friarielli", desc: "Salsiccia di maiale con finocchietto e friarielli", price: 18.00 },
                    { id: 305, name: "Petto di pollo grigliato", desc: "Petto di pollo grigliato con 1 contorno a scelta", price: 15.00 },
                    { id: 306, name: "Hamburger al piatto", desc: "Hamburger 180gr al piatto con 1 contorno a scelta", price: 12.00 }
                ]
            },
            {
                id: "contorni", category: "Contorni",
                items: [
                    { id: 401, name: "Patate fritte", desc: "", price: 4.50 },
                    { id: 402, name: "Patate al forno", desc: "", price: 5.00 },
                    { id: 403, name: "Friarielli", desc: "", price: 6.00 },
                    { id: 404, name: "Insalata verde", desc: "", price: 4.00 },
                    { id: 405, name: "Rucola e pomodorini", desc: "", price: 5.00 }
                ]
            },
            {
                id: "birre-bottiglia", category: "Birre in Bottiglia",
                items: [
                    { id: 711, name: "Hofbrau Munchen - Pure", desc: "Dorata Chiara, Helles (Alc: 5.3% Germania) - 33cl", price: 4.50 },
                    { id: 712, name: "Flensburger - Gold", desc: "Dorata, Export Lager (Alc: 4.8% Germania) - 33cl", price: 6.50 },
                    { id: 713, name: "Flensburger - Weizen", desc: "Dorata Velata, Hefeweizen (Alc: 5.1% Germania) - 33cl", price: 6.50 },
                    { id: 714, name: "Flensburger - Dunkel", desc: "Ambrata Scura, Dunkel Lager (Alc: 4.8% Germania) - 33cl", price: 6.50 },
                    { id: 715, name: "Ventitre - Mida", desc: "Dorata, Belgian Golden Strong (Alc: 8% Italia) - 33cl", price: 10.00 },
                    { id: 716, name: "Tyris - Marzen", desc: "Ambrata, M√§rzen (Alc: 5.5% Spagna) - 33cl", price: 9.00 },
                    { id: 717, name: "Gouden Carolus - Ambrio", desc: "Ambrata, Belgian Amber Ale (Alc: 8% Belgio) - 33cl", price: 9.50 },
                    { id: 718, name: "Gouden Carolus - Triple", desc: "Dorata, Belgian Triple (Alc: 9% Belgio) - 33cl", price: 9.50 },
                    { id: 719, name: "Krombacher Pils Alkoholfree", desc: "Pils Analcolica (Alc: 0% Germania) - 33cl", price: 4.00 }
                ]
            },
            {
                id: "dolci", category: "Dolci (Anima Dolce)",
                items: [
                    { id: 501, name: "Pastiera", desc: "La versione scomposta della pastiera, con crumble al burro, ricotta e grano", price: 7.00 },
                    { id: 502, name: "Cheesecake ai Frutti Rossi", desc: "Crumble al burro, crema al formaggio, composta ai frutti rossi", price: 7.00 },
                    { id: 503, name: "Birramis√π", desc: "Mousse al mascarpone, crema alla birra, crumble al burro", price: 7.00 },
                    { id: 504, name: "Tiramisu", desc: "Savoiardo bagnato al caff√®, cuore di cioccolato al caramello, mousse al mascarpone", price: 7.00 },
                    { id: 505, name: "Delizia al limone", desc: "Pan di spagna al limoncello, crema chantilly al limone", price: 7.00 }
                ]
            },
            {
                id: "bibite", category: "Bibite",
                items: [
                    { id: 601, name: "Acqua Ferrarelle", desc: "", price: 3.00 },
                    { id: 602, name: "Acqua Electa", desc: "", price: 3.00 },
                    { id: 603, name: "Coca cola", desc: "", price: 3.00 },
                    { id: 604, name: "Coca cola zero", desc: "", price: 3.00 },
                    { id: 605, name: "Fanta", desc: "", price: 3.00 }
                ]
            }
        ];

        let cart = {}; let itemMap = {}; let currentCustomItemId = null;

        function buildItemMap() {
            menuData.forEach(cat => cat.items.forEach(i => { i.categoryId = cat.id; itemMap[i.id] = i; }));
        }

        function initApp() { buildItemMap(); renderFilters(); renderMenu(); }

        function renderFilters() {
            const fc = document.getElementById('filters-container');
            fc.innerHTML = `<button class="filter-btn active" onclick="filterMenu('all', this)">Tutti</button>`;
            menuData.forEach(cat => {
                fc.innerHTML += `<button class="filter-btn" onclick="filterMenu('${cat.id}', this)">${cat.category}</button>`;
            });
        }

        function filterMenu(catId, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.category-section').forEach(sec => {
                if (catId === 'all' || sec.id === `cat-${catId}`) sec.classList.remove('hidden'); else sec.classList.add('hidden');
            });
            window.scrollTo({ top: document.getElementById('filters-container').offsetTop - 10, behavior: 'smooth' });
        }

        function renderMenu() {
            const container = document.getElementById('menu-container');
            menuData.forEach(cat => {
                let html = `<div class="category-section" id="cat-${cat.id}"><h2 class="category-title">${cat.category}</h2>`;
                cat.items.forEach(item => {
                    let hideCustomBtn = (cat.id === 'bibite' || cat.id === 'birre-bottiglia' || cat.id === 'contorni' || !item.desc);
                    let customBtn = hideCustomBtn ? '' : `<button class="btn-custom" onclick="openCustomModal(${item.id})"><i class="fa-solid fa-pen"></i> Rimuovi Ingr.</button>`;
                    
                    html += `
                        <div class="menu-item">
                            <div class="item-header">
                                <div class="item-name">${item.name}</div>
                                <div class="item-price">${item.price.toFixed(2).replace('.',',')}‚Ç¨</div>
                            </div>
                            <p class="item-desc">${item.desc}</p>
                            <div class="controls">
                                ${customBtn}
                                <div style="flex-grow:1;"></div>
                                <div class="qty-box">
                                    <button class="btn-control" onclick="handleRemoveClick('${item.id}')"><i class="fa-solid fa-minus"></i></button>
                                    <span class="qty" id="qty-${item.id}">0</span>
                                    <button class="btn-control" onclick="handleAddClick('${item.id}')"><i class="fa-solid fa-plus"></i></button>
                                </div>
                            </div>
                            <div id="variants-${item.id}"></div>
                        </div>`;
                });
                html += `</div>`;
                container.innerHTML += html;
            });
        }

        function handleAddClick(id) { updateQty(id, 1); }
        function handleRemoveClick(id) {
            let baseCount = cart[id] || 0;
            let variants = Object.keys(cart).filter(k => k.startsWith('c_' + id + '_') && cart[k] > 0);
            if (variants.length === 1 && baseCount === 0) updateQty(variants[0], -1);
            else if (variants.length > 0 || baseCount > 0) {
                if (variants.length === 0) updateQty(id, -1);
                else alert("Rimuovi le varianti usando i tasti delle singole voci.");
            }
        }

        function updateQty(id, change) {
            cart[id] = (cart[id] || 0) + change;
            if (cart[id] < 0) cart[id] = 0;
            
            if (itemMap[id] && itemMap[id].isCustom) {
                document.getElementById(`variant-${id}`).style.display = cart[id] > 0 ? 'block' : 'none';
                document.getElementById(`qty-${id}`).innerText = cart[id];
                updateBaseQty(itemMap[id].baseId);
            } else {
                document.getElementById(`qty-${id}`).innerText = cart[id];
                updateBaseQty(id);
            }
            updateCartUI();
        }

        function updateBaseQty(baseId) {
            let total = cart[baseId] || 0;
            for(let id in cart) if(cart[id] > 0 && itemMap[id]?.isCustom && itemMap[id].baseId == baseId) total += cart[id];
            document.getElementById(`qty-${baseId}`).innerText = total;
        }

        function updateCartUI() {
            let subtotal = 0, count = 0;
            for(let id in cart) {
                if (cart[id] > 0 && itemMap[id]) { subtotal += itemMap[id].price * cart[id]; count += cart[id]; }
            }
            
            // CALCOLO SCONTI 10% e 20%
            let discountRate = 0;
            if(subtotal >= 50) discountRate = 0.20;
            else if(subtotal >= 20) discountRate = 0.10;

            let total = subtotal * (1 - discountRate);

            let priceHtml = '';
            if(discountRate > 0) {
                priceHtml = `<span style="text-decoration:line-through; font-size:0.9rem; color:var(--text-muted); margin-right:8px;">${subtotal.toFixed(2).replace('.',',')}‚Ç¨</span>${total.toFixed(2).replace('.',',')} ‚Ç¨ <span style="font-size:0.8rem; color:var(--accent-fire); font-weight:800; margin-left:5px;">-${discountRate*100}%</span>`;
            } else {
                priceHtml = `${total.toFixed(2).replace('.',',')} ‚Ç¨`;
            }

            document.getElementById('total-price').innerHTML = priceHtml;
            const f = document.getElementById('cart-footer');
            count > 0 ? f.classList.add('visible') : f.classList.remove('visible');
        }

        function openCustomModal(id) {
            currentCustomItemId = id;
            const item = itemMap[id];
            document.getElementById('custom-title').innerText = item.name;
            let html = '';
            if(item.desc) {
                let parts = item.desc.split(/ e |,| con /i).map(s => s.trim()).filter(s => s.length > 2);
                parts.forEach(ing => {
                    html += `<label class="custom-option-card"><div class="custom-option-left"><input type="checkbox" value="${ing}" class="rm-chk"> Senza ${ing}</div></label>`;
                });
            }
            document.getElementById('custom-dynamic-sections').innerHTML = html || "<p style='color:var(--text-muted);font-weight:500;'>Nessun ingrediente modificabile.</p>";
            document.getElementById('custom-modal').classList.add('active');
        }
        function closeCustomModal() { document.getElementById('custom-modal').classList.remove('active'); currentCustomItemId = null; }
        
        function addCustomItemToCart() {
            if(!currentCustomItemId) return;
            const item = itemMap[currentCustomItemId];
            let rems = Array.from(document.querySelectorAll('.rm-chk:checked')).map(c => c.value);
            if(rems.length === 0) { updateQty(item.id, 1); closeCustomModal(); return; }
            
            let sig = `${item.id}|${rems.sort().join('-')}`;
            let hash = Math.abs(sig.split('').reduce((a,b)=>{a=((a<<5)-a)+b.charCodeAt(0);return a&a},0));
            let cId = "c_" + item.id + "_" + hash;

            if(!itemMap[cId]) {
                itemMap[cId] = { id: cId, baseId: item.id, name: item.name, price: item.price, isCustom: true, removed: rems };
                let h = `<div class="variant-item" id="variant-${cId}">
                    <div class="variant-header"><span>Variante Custom</span>
                        <div style="display:flex;gap:10px;"><button class="btn-control" onclick="updateQty('${cId}',-1)">-</button><span class="qty" id="qty-${cId}">0</span><button class="btn-control" onclick="updateQty('${cId}',1)">+</button></div>
                    </div>
                    <div class="variant-desc">- Senza ${rems.join(', ')}</div></div>`;
                document.getElementById(`variants-${item.id}`).insertAdjacentHTML('beforeend', h);
            }
            updateQty(cId, 1); closeCustomModal();
        }

        function removeFromRecap(id) { if(cart[id]>0){ updateQty(id, -cart[id]); openRecap(); } }
        
        function openRecap() {
            const rc = document.getElementById('recap-list-container'); rc.innerHTML = '';
            let totItems = 0;
            let subtotal = 0;

            for(let id in cart) {
                if(cart[id]>0 && itemMap[id]) {
                    totItems++;
                    let i = itemMap[id];
                    subtotal += i.price * cart[id];
                    let txt = i.isCustom ? `<br><small style="color:var(--accent-fire)">Senza ${i.removed.join(', ')}</small>` : '';
                    rc.innerHTML += `<div class="recap-item"><div><strong>${cart[id]}x</strong> ${i.name} ${txt}</div><div style="display:flex;gap:15px;align-items:center;"><span style="color:var(--text-main); font-weight:800;">${(i.price*cart[id]).toFixed(2)}‚Ç¨</span><button class="btn-remove-recap" onclick="removeFromRecap('${id}')"><i class="fa-solid fa-xmark"></i></button></div></div>`;
                }
            }
            if(totItems===0) { closeRecap(); return; }

            // MESSAGGI GAMIFICATION SCONTI NEL RECAP
            const promoAlertBox = document.getElementById('recap-promo-alert');
            if(subtotal < 20) {
                let missing = 20 - subtotal;
                promoAlertBox.innerHTML = `<div class="promo-alert">Mancano solo <strong>${missing.toFixed(2).replace('.',',')}‚Ç¨</strong> per sbloccare il <strong>10% di sconto</strong> su tutto l'ordine!</div>`;
            } else if (subtotal < 50) {
                let missing = 50 - subtotal;
                promoAlertBox.innerHTML = `<div class="promo-alert success">üî• Hai sbloccato il <strong>10% di sconto</strong>!<br>Aggiungi <strong>${missing.toFixed(2).replace('.',',')}‚Ç¨</strong> per avere il <strong>20% di sconto</strong>.</div>`;
            } else {
                promoAlertBox.innerHTML = `<div class="promo-alert success">üî• COMPLIMENTI! Hai sbloccato il <strong>MASSIMO SCONTO (20%)</strong>! üî•</div>`;
            }

            const uc = document.getElementById('upsell-container'); uc.innerHTML = '';
            let inCart = Object.keys(cart).filter(k=>cart[k]>0).map(k=>itemMap[k]?.baseId || itemMap[k]?.id);
            
            const drinkCategories = ['bibite', 'birre-bottiglia'];
            let hasDrink = inCart.some(id => drinkCategories.includes(itemMap[id]?.categoryId));
            let available = []; menuData.forEach(c=>c.items.forEach(i=> { if(!inCart.includes(i.id)) available.push(i); }));
            
            let upsells = [];
            if(!hasDrink) {
                let dr = available.filter(i=> drinkCategories.includes(i.categoryId)).sort(()=>0.5-Math.random());
                if(dr.length) upsells.push(dr[0]);
            }
            let food = available.filter(i=> !drinkCategories.includes(i.categoryId) && !upsells.includes(i)).sort(()=>0.5-Math.random());
            while(upsells.length < 3 && food.length > 0) upsells.push(food.pop());

            upsells.forEach(u => {
                uc.innerHTML += `<div class="upsell-card"><h4>${u.name}</h4><p style="color:var(--accent-gold);font-weight:900; font-size: 1.1rem;">${u.price.toFixed(2)}‚Ç¨</p><button class="btn-upsell" onclick="updateQty(${u.id},1); openRecap();">+ Aggiungi</button></div>`;
            });
            document.getElementById('recap-modal').classList.add('active');
        }

        function closeRecap() { document.getElementById('recap-modal').classList.remove('active'); }
        
        function proceedToCheckout() { 
            closeRecap(); 
            popolaOrari(); 
            
            // COSTRUISCI MINI RIEPILOGO NEL CHECKOUT
            let subtotal = 0;
            for(let id in cart) {
                if(cart[id]>0 && itemMap[id]) subtotal += itemMap[id].price * cart[id];
            }
            
            let discountRate = 0;
            if(subtotal >= 50) discountRate = 0.20;
            else if(subtotal >= 20) discountRate = 0.10;

            let discountAmount = subtotal * discountRate;
            let total = subtotal - discountAmount;

            let infoHtml = `<div style="background:var(--bg-body); padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid var(--border-light);">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:0.9rem;"><span>Subtotale:</span> <span>${subtotal.toFixed(2).replace('.',',')}‚Ç¨</span></div>`;
            
            if(discountRate > 0) {
                infoHtml += `<div style="display:flex; justify-content:space-between; margin-bottom:5px; color:var(--accent-fire); font-weight:bold; font-size:0.9rem;"><span>Sconto ${discountRate*100}%:</span> <span>-${discountAmount.toFixed(2).replace('.',',')}‚Ç¨</span></div>`;
            }

            infoHtml += `<div style="display:flex; justify-content:space-between; margin-top:10px; padding-top:10px; border-top:1px dashed var(--border-light); font-weight:900; font-size:1.3rem; color:var(--accent-gold);"><span>TOTALE:</span> <span>${total.toFixed(2).replace('.',',')}‚Ç¨</span></div></div>`;

            // AVVISO SCONTO ANCHE NEL CHECKOUT CON TASTO PER TORNARE AL CARRELLO
            if(subtotal < 20) {
                let missing = 20 - subtotal;
                infoHtml += `<div class="promo-alert" style="cursor:pointer;" onclick="closeCheckout(); openRecap();">
                    Aggiungi solo <strong>${missing.toFixed(2).replace('.',',')}‚Ç¨</strong> per avere il <strong>10% di Sconto</strong>!<br>
                    <span style="text-decoration:underline; font-size:0.8rem; font-weight:bold;">Clicca qui per aggiungere altro</span>
                </div>`;
            } else if(subtotal < 50) {
                let missing = 50 - subtotal;
                infoHtml += `<div class="promo-alert success" style="cursor:pointer;" onclick="closeCheckout(); openRecap();">
                    üî• Sconto 10% Attivo! Aggiungi <strong>${missing.toFixed(2).replace('.',',')}‚Ç¨</strong> per il <strong>20%</strong>!<br>
                    <span style="text-decoration:underline; font-size:0.8rem; font-weight:bold;">Clicca qui per aggiungere altro</span>
                </div>`;
            }

            document.getElementById('checkout-order-info').innerHTML = infoHtml;
            document.getElementById('checkout-modal').classList.add('active'); 
        }

        function closeCheckout() { document.getElementById('checkout-modal').classList.remove('active'); }

        function popolaOrari() {
            const select = document.getElementById('orario-consegna');
            select.innerHTML = '';
            
            let now = new Date();
            now.setMinutes(now.getMinutes() + 15);
            
            let h = now.getHours();
            let m = now.getMinutes();
            
            let remainder = m % 15;
            if (remainder !== 0) {
                m = m + (15 - remainder);
            }
            if (m >= 60) { m -= 60; h++; }

            let slotAggiunti = 0;
            for(let i=0; i<12; i++) { 
                let displayH = h % 24; 
                let hh = String(displayH).padStart(2, '0');
                let mm = String(m).padStart(2, '0');
                
                select.innerHTML += `<option value="${hh}:${mm}">${hh}:${mm}</option>`;
                slotAggiunti++;
                
                m += 15;
                if (m >= 60) { m -= 60; h++; }
            }

            if (slotAggiunti === 0) {
                select.innerHTML = `<option value="">Locale chiuso</option>`;
                document.getElementById('pay-btn').disabled = true;
            }
        }

        async function sendOrderWithDetails() {
            const name = document.getElementById('cust-name').value.trim();
            const time = document.getElementById('orario-consegna').value;
            const notes = document.getElementById('cust-notes').value.trim();
            
            if(!name || !time) {
                alert("Compila il nome e l'orario per il ritiro.");
                return; 
            }

            const orderId = `TRB-${name.substring(0,2).toUpperCase()}-${Math.floor(1000+Math.random()*9000)}`;
            let items=[], subtotal=0;
            let txt = `*NUOVO ORDINE TORB* ü•©\nüÜî Rif: ${orderId}\nüë§ Cliente: ${name}\nüïí Ritiro: ${time}\n`;
            if(notes) txt += `üìù Note: ${notes}\n`;
            txt += `\n*ORDINE:*\n`;

            for(let id in cart) {
                if(cart[id]>0 && itemMap[id]) {
                    let i = itemMap[id];
                    items.push({ name: i.name, price: i.price, qty: cart[id] });
                    subtotal += i.price*cart[id];
                    let varTxt = i.isCustom ? `\n   ‚Ü≥ Senza: ${i.removed.join(', ')}` : '';
                    txt += `‚ñ´Ô∏è ${cart[id]}x ${i.name} (${(i.price*cart[id]).toFixed(2)}‚Ç¨)${varTxt}\n`;
                }
            }

            // APPLICAZIONE SCONTO AL TOTALE
            let discountRate = 0;
            if(subtotal >= 50) discountRate = 0.20;
            else if(subtotal >= 20) discountRate = 0.10;

            let total = subtotal;

            if(discountRate > 0) {
                let discountAmount = subtotal * discountRate;
                total = subtotal - discountAmount;
                
                // Aggiungiamo lo sconto come "prodotto con prezzo negativo"
                items.push({ name: `Sconto PROMO ${discountRate*100}%`, price: -discountAmount, qty: 1 });
                txt += `\nüéÅ *SCONTO APPLICATO (${discountRate*100}%):* -${discountAmount.toFixed(2)}‚Ç¨\n`;
            }
            
            if (total < 1.00) { 
                alert("Attenzione: L'ordine minimo per SumUp √® 1.00 ‚Ç¨!"); 
                return; 
            }

            txt += `\nüí∞ *PAGATO (SumUp): ${total.toFixed(2)} ‚Ç¨*`;
            localStorage.setItem('torb_order', txt);

            const btn = document.getElementById('pay-btn');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Connessione a SumUp...'; 
            btn.disabled = true;

            try {
                const WORKER_URL = "/paga"; 

                const response = await fetch(WORKER_URL, {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items: items, orderId: orderId })
                });
                
                if (!response.ok) {
                    throw new Error(`Errore Server: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                
                if (data.checkoutId) { 
                    document.getElementById('dati-cliente-form').style.display = 'none';
                    document.getElementById('checkout-order-info').style.display = 'none';
                    document.getElementById('sumup-card-container').style.display = 'block';
                    
                    SumUpCard.mount({
                        id: 'sumup-card', 
                        checkoutId: data.checkoutId,
                        
                        googlePay: { merchantId: 'INSERISCI_ID_GOOGLE', merchantName: 'TORB Birreria' },
                        applePay: { merchantName: 'TORB Birreria' },

                        onResponse: function(type, body) {
                            if (type === 'success' && body.status === 'PAID') {
                                window.location.href = "successo.html";
                            } 
                            else if (type === 'success' && body.status === 'FAILED') {
                                alert("Transazione negata dalla banca. Verifica i fondi e riprova.");
                                window.location.href = "errore.html";
                            } 
                            else if (type === 'error' || type === 'fail' || type === 'declined') {
                                alert("Errore durante il pagamento: " + (body.message || JSON.stringify(body)));
                                window.location.href = "errore.html";
                            }
                        }
                    });
                } else {
                    alert("SumUp non ha generato il checkout. Risposta del server: " + JSON.stringify(data));
                    btn.innerHTML = '<i class="fa-solid fa-credit-card"></i> Paga Ora (SumUp)'; 
                    btn.disabled = false;
                }
            } catch(e) { 
                alert("Errore di rete o Backend non trovato!\nVerifica che il link /paga esista su questo sito.\n\nDettaglio: " + e.message); 
                btn.innerHTML = '<i class="fa-solid fa-credit-card"></i> Paga Ora (SumUp)'; 
                btn.disabled = false; 
            }
        }

        window.onload = initApp;
    </script>
</body>
</html>